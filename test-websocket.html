<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DM WebSocket 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .box { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .messages { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        input, button { margin: 5px; padding: 8px; }
        .user-me { text-align: right; color: blue; }
        .user-other { text-align: left; color: green; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DM WebSocket 테스트</h1>
        
        <div class="box">
            <h3>연결 설정</h3>
            <input type="text" id="userPid" value="user_me" placeholder="사용자 PID">
            <button onclick="connect()">WebSocket 연결</button>
            <button onclick="disconnect()">연결 해제</button>
            <div id="connectionStatus">연결 안됨</div>
        </div>

        <div class="box">
            <h3>스레드 구독</h3>
            <input type="number" id="threadId" value="1" placeholder="스레드 ID">
            <button onclick="subscribe()">스레드 구독</button>
        </div>

        <div class="box">
            <h3>메시지</h3>
            <div id="messages" class="messages"></div>
            <input type="text" id="messageInput" placeholder="메시지 입력" style="width: 70%;">
            <button onclick="sendMessage()">전송 (HTTP)</button>
        </div>

        <div class="box">
            <h3>REST API 테스트</h3>
            <button onclick="createThread()">스레드 생성 (user_me ↔ user_21)</button>
            <button onclick="getThreads()">스레드 목록 조회</button>
            <button onclick="getMessages()">메시지 목록 조회</button>
            <div id="apiResults" style="background: #f0f0f0; padding: 10px; margin-top: 10px; white-space: pre-wrap;"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentUserPid = 'user_me';
        let currentThreadId = 1;

        function connect() {
            currentUserPid = document.getElementById('userPid').value;
            ws = new WebSocket('ws://localhost:8080/ws/messages');
            
            ws.onopen = function() {
                document.getElementById('connectionStatus').innerHTML = '연결됨';
                
                // 초기화 메시지 전송
                ws.send(JSON.stringify({
                    type: 'INIT',
                    currentUserPid: currentUserPid
                }));
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                addMessage(`[WebSocket] ${JSON.stringify(message, null, 2)}`);
            };
            
            ws.onclose = function() {
                document.getElementById('connectionStatus').innerHTML = '연결 해제됨';
            };
            
            ws.onerror = function(error) {
                document.getElementById('connectionStatus').innerHTML = '오류: ' + error;
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function subscribe() {
            currentThreadId = parseInt(document.getElementById('threadId').value);
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'SUBSCRIBE',
                    threadId: currentThreadId
                }));
                addMessage(`스레드 ${currentThreadId} 구독 요청 전송`);
            } else {
                alert('먼저 WebSocket에 연결하세요.');
            }
        }

        function addMessage(text) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + text + '</div>';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const content = document.getElementById('messageInput').value;
            if (!content) return;

            // HTTP POST로 메시지 전송
            fetch(`http://localhost:8080/messages/threads/${currentThreadId}/messages`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    currentUserPid: currentUserPid,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                addMessage(`[HTTP 전송] ${JSON.stringify(data)}`);
                document.getElementById('messageInput').value = '';
            })
            .catch(error => {
                addMessage(`[HTTP 오류] ${error}`);
            });
        }

        function createThread() {
            fetch('http://localhost:8080/messages/threads', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    currentUserPid: 'user_me',
                    targetPid: 'user_21'
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('apiResults').textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                document.getElementById('apiResults').textContent = 'Error: ' + error;
            });
        }

        function getThreads() {
            fetch('http://localhost:8080/messages/threads?currentUserPid=user_me')
            .then(response => response.json())
            .then(data => {
                document.getElementById('apiResults').textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                document.getElementById('apiResults').textContent = 'Error: ' + error;
            });
        }

        function getMessages() {
            fetch(`http://localhost:8080/messages/threads/${currentThreadId}?currentUserPid=user_me`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('apiResults').textContent = JSON.stringify(data, null, 2);
            })
            .catch(error => {
                document.getElementById('apiResults').textContent = 'Error: ' + error;
            });
        }
    </script>
</body>
</html>